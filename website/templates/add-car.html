{% extends "base.html" %}
{% block title %}Add Car{% endblock %}

{% block content %}

<style>
    .form-control,
    .form-select {
        border-radius: 0.75rem;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.125);
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(38, 143, 255, 0.25);
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004080;
    }



    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
        transition: background-color 0.2s ease, border-color 0.2s ease;
    }

    .btn-success:hover {
        background-color: #218838;
        border-color: #1e7e34;
    }

    @media (min-width: 768px) {
        .col-md-6 {
            -ms-flex: 0 0 50%;
            flex: 0 0 50%;
            max-width: 30%;
        }
    }

    .upper_buttons {
        margin-top: -4px;
    }

    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }

    .form-check-label {
        margin-bottom: 0;
    }

    .container {
        max-width: 900px;
    }

    .form-label {
        font-weight: bold;
        color: #333;
    }

    .bg-light {
        background-color: #f8f9fa;
    }

    .border {
        border: 1px solid #dee2e6;
    }

    .rounded {
        border-radius: 0.75rem;
    }

    .shadow-lg {
        box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.2);
    }

    .text-center {
        text-align: center;
    }

    .w-100 {
        width: 100%;
    }

    .car-segment-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0rem;
    }

    .car-segment-container .form-check {
        flex: 1 1 calc(33.333% - 1rem);
        box-sizing: border-box;
    }

    .car-segment-container .form-check input {
        margin-right: 0.5rem;
    }

    .form-check-label {
        font-size: 1rem;
    }


    .btn-container {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    #delete_brand_btn {
        transition: all 0.3s ease; 
        border-radius: 0.5rem; 
        /* padding: 0.5rem 1rem;  */
        font-size: 13px;
    }

    #delete_brand_btn:hover {
        opacity: 0.8; 
        transform: scale(1.05); 
    }

    #edit_brand_name_btn {
        transition: all 0.3s ease; 
        border-radius: 0.5rem; 
        /* padding: 0.5rem 1rem;  */
        font-size: 13px;
    }

    #edit_brand_name_btn:hover {
        opacity: 0.8; 
        transform: scale(1.05); 
    }

    #auto_fill_btn {
        transition: all 0.3s ease; 
        border-radius: 0.5rem; 
        padding: 0.5rem 1rem; 
    }

    #auto_fill_btn:hover {
        opacity: 0.8; 
        transform: scale(1.05); 
    }

    #manual_fill_btn {
        transition: all 0.3s ease; 
        border-radius: 0.5rem; 
        padding: 0.5rem 1rem; 
    }

    #manual_fill_btn:hover {
        opacity: 0.8; 
        transform: scale(1.05); 
    }

    .section-header {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        border-bottom: 2px solid #686a6c;
        padding-bottom: 0.5rem;
        margin-bottom: 2rem;
    }

    .second_section {
        display: none;
    }
</style>

<div class="container mt-5">
    <h3 class="section-header text-center">Add A New Car</h3>

    <form method="POST" action="{{ url_for('admin.add_car') }}" enctype="multipart/form-data"
        class="p-4 border rounded shadow-lg bg-white">

        <div class="first_sction">
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="car_brand" class="form-label">Car Brand</label>
                    <select id="car_brand" name="car_brand" class="form-select" required>
                        <option value="" disabled selected>Select a brand</option>
                        {% for brand in car_brands %}
                        <option value="{{ brand.name }}">{{ brand.name }}</option>
                        {% endfor %}
                    </select>
                   
                </div>
                <div class="upper_buttons">
                    <button type="button" id="edit_brand_name_btn" class="btn btn-warning" onclick="editSelectedBrandName()">Edit Brand
                        Name</button>
                    <button type="button" id="delete_brand_btn" class="btn btn-danger" onclick="deleteSelectedBrand()">Delete
                        Brand</button>
                </div>
                
            </div>

            <div class="mb-4">
                <label for="car_model" class="form-label">Car Model</label>
                <input type="text" id="car_model" name="car_model" class="form-control" placeholder="Enter car model"
                    required>
            </div>

            <div class="mb-4">
                <label for="year" class="form-label">Year</label>
                <input type="number" id="year" name="year" class="form-control" placeholder="Enter car year" required>
            </div>

            <div class="btn-container d-flex justify-content-center gap-2">
                <button type="button" id="auto_fill_btn" class="btn btn-success" onclick="autoFillWithAI()">Auto Fill wit AI</button>
                <button type="button" id="manual_fill_btn" class="btn btn-info" onclick="showSecondSection()">Filling Manually</button>
            </div>

        </div>

    <div div id="second_section" class="second_section">
        <br />
        <h3 class="section-header text-center">Car Specs</h3>
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="range" class="form-label">Range (km)</label>
                <input type="number" id="range" name="range" class="form-control" placeholder="Enter the car range"
                    required>
            </div>

            <div class="col-md-6">
                <label for="weight" class="form-label">Car Weight (kg)</label>
                <input type="number" id="weight" name="weight" class="form-control" placeholder="Enter the car weight"
                    required>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="horse_power" class="form-label">Horse Power (hp)</label>
                <input type="number" id="horse_power" name="horse_power" class="form-control"
                    placeholder="Enter horsepower" required>
            </div>

            <div class="col-md-6">
                <label for="acceleration" class="form-label">Acceleration (0-100 km/h)</label>
                <input type="number" id="acceleration" name="acceleration" class="form-control"
                    placeholder="Enter acceleration" step="0.1" min="0" max="100" required>
            </div>
        </div>

        <div class="mb-4">
            <label for="fast_chargingTime" class="form-label">Fast Charging Time (minutes)</label>
            <input type="number" id="fast_chargingTime" name="fast_chargingTime" class="form-control"
                placeholder="Enter fast charging time" required>
        </div>

        <div class="mb-4">
            <label for="manufacturing_country" class="form-label">Manufacturing Country</label>
            <select id="manufacturing_country" name="manufacturing_country" class="form-select" required>
                <option value="" disabled selected>Select a country</option>
                <option value="USA">USA</option>
                <option value="Germany">Germany</option>
                <option value="Spain">Spain</option>
                <option value="Italy">Italy</option>
                <option value="Czech">Czech</option>
                <option value="France">France</option>
                <option value="Japan">Japan</option>
                <option value="Korea">Korea</option>
                <option value="South Korea">South Korea</option>
                <option value="China">China</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="form-label">Car Segment (You can choose more than one)</label>
            <div class="car-segment-container">
                {% for segment in ["A (Mini Cars)", "B (Small Cars)", "C (Medium Cars)", "D (Large Cars)", "Jeep",
                "Sedan", "SUV", "Hatchback", "Premium", "Sport"] %}
                <div class="form-check">
                    <input type="checkbox" id="{{ segment }}" name="car_segment" value="{{ segment }}"
                        class="form-check-input">
                    <label for="{{ segment }}" class="form-check-label">{{ segment }}</label>
                </div>
                {% endfor %}
                <!-- <div class="form-check">
                    <input type="checkbox" id="any_segment" name="car_segment" value="Any_segment"
                        class="form-check-input">
                    <label for="any_segment" class="form-check-label">Any Segment</label>
                </div> -->
            </div>
        </div>

        <div class="mb-4">
            <label for="ncap_rating" class="form-label">EURO NCAP Star Safety Rating (Choose 0 if there were not crash
                tests)</label>
            <select id="ncap_rating" name="ncap_rating" class="form-select" required>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
        </div>

        <div class="mb-4">
            <label for="screen_size" class="form-label">Multimedia Screen Size (in inches)</label>
            <input type="number" id="screen_size" name="screen_size" class="form-control"
                placeholder="Enter screen size" step="0.1" required>
        </div>

        <div class="mb-4">
            <label for="car_image" class="form-label">Car Image URL</label>
            <input type="url" id="car_image" name="car_image" class="form-control" placeholder="Enter URL to an image"
                required>
        </div>

        <div class="mb-4">
            <label for="car_data_url" class="form-label">Car Data Source (EV-Database)</label>
            <input type="url" id="car_data_url" name="car_data_url" class="form-control" placeholder="Enter URL to the page in evdatabase" required>
        </div>


        <div class="mb-4">
            <label for="price" class="form-label">Price (ILS)</label>
            <input type="number" id="price" name="price" class="form-control" placeholder="Enter car price" required>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100">Add Car</button>
    </div>

    </form>

    <hr class="my-5">

    <h3 class="section-header text-center">Manage Car Brands</h3>
    <div id="manage_brands_form" class="mt-4">
        <form id="add_brand_form" method="POST" action="{{ url_for('admin.addNewBrand') }}"
            class="p-4 border rounded shadow-lg bg-white">
            <div class="mb-4">
                <label for="new_brand" class="form-label">New Car Brand</label>
                <input type="text" id="new_brand" name="new_brand" class="form-control" placeholder="Enter new brand"
                    required>
            </div>
            <button type="submit" id="save_brand_btn" class="btn btn-success btn-lg w-100">Save Brand</button>
        </form>
    </div>
</div>

<br />
<br />

<script>

    function showSecondSection() {
        document.getElementById('second_section').style.display = 'block';
    }

    function deleteSelectedBrand() {
        var selectElement = document.getElementById('car_brand');
        var selectedBrandId = selectElement.value;

        if (selectedBrandId) {
            fetch('/delete-brand', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ brandId: selectedBrandId })
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        console.error('Error deleting brand');
                    }
                });
        } else {
            alert('Please select a brand to delete.');
        }
    }

    function editSelectedBrandName() {
        var selectElement = document.getElementById('car_brand');
        var selectedBrandId = selectElement.value;
        var newName = prompt("Enter the new name for the selected brand:");

        if (selectedBrandId && newName) {
            fetch('/edit-brand', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ brandId: selectedBrandId, newName: newName })
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        return response.json().then(data => {
                            console.error('Error updating brand:', data.message);
                        });
                    }
                });
        } else {
            alert('Please select a brand and enter a new name.');
        }
    }


    function autoFillWithAI() {

        document.getElementById('second_section').style.display = 'none';


        const carBrand = document.getElementById('car_brand').value;
        const carModel = document.getElementById('car_model').value;
        const year = document.getElementById('year').value;

        if (!carBrand || !carModel || !year) {
            alert('Please fill in all required fields: Brand, Model, and Year.');
            document.getElementById('second_section').style.display = 'none';
            return;
        }
        else {
            setTimeout(function () {
                document.getElementById('second_section').style.display = 'block';
            }, 2000);
        }

        fetch('/auto-fill-car-details', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ car_brand: carBrand, car_model: carModel, year: year })
        })
        .then(response => response.json())
        .then(data => {
            if (data) {
                document.getElementById('range').value = data.range || '';
                document.getElementById('weight').value = data.car_weight || '';
                document.getElementById('horse_power').value = data.horse_power || '';
                document.getElementById('acceleration').value = data.acceleration || '';
                document.getElementById('fast_chargingTime').value = data.fast_charging_time || '';

                document.getElementById('manufacturing_country').value = data.manufacturing_country || 'None';
                document.getElementById('ncap_rating').value = data.euro_ncap_rating || '0';
                document.getElementById('screen_size').value = data.screen_size || '1'

                // document.getElementById('car_image').value = data.car_image || '';
                // document.getElementById('car_data_url').value = data.car_image || '';

                document.getElementById('price').value = data.price || ''


                const segmentsString = data.car_segment || '';
                const segments = segmentsString.split(',').map(segment => segment.trim());
                const allCheckboxes = document.querySelectorAll('input[name="car_segment"]');

                allCheckboxes.forEach(checkbox => {
                    console.log('Checkbox Value:', checkbox.value, 'Checked:', segments.includes(checkbox.value));
                    checkbox.checked = segments.includes(checkbox.value);
                });
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}